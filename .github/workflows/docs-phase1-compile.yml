name: Docs Phase 1 Compile

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "ESPS/**"
      - "devtools/compile-docs-phase1.sh"
      - "devtools/README.md"
      - ".github/workflows/docs-phase1-compile.yml"
  push:
    branches:
      - main
    paths:
      - "ESPS/**"
      - "devtools/compile-docs-phase1.sh"
      - "devtools/README.md"
      - ".github/workflows/docs-phase1-compile.yml"

jobs:
  compile-docs-phase1:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Doc Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y groff bsdextrautils

      - name: Run Phase 1 Docs Compile (strict errors)
        id: compile
        continue-on-error: true
        run: |
          ./devtools/compile-docs-phase1.sh \
            --out-dir build/docs-phase1-ci \
            --strict errors \
            --scope core \
            --keep-going

      - name: Show Summary
        if: always()
        run: |
          if [ -f build/docs-phase1-ci/summary.md ]; then
            sed -n '1,200p' build/docs-phase1-ci/summary.md
          else
            echo "summary.md not found"
          fi

      - name: Upload Compile Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-phase1-compile
          if-no-files-found: warn
          path: |
            build/docs-phase1-ci/summary.md
            build/docs-phase1-ci/summary.json
            build/docs-phase1-ci/logs

      - name: Enforce Strict Errors Result
        if: steps.compile.outcome != 'success'
        run: |
          echo "compile-docs-phase1 failed under --strict errors"
          exit 1
