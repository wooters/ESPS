name: Docs Phase 2 Site

on:
  workflow_dispatch:

jobs:
  build-docs-phase2:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y groff bsdextrautils pandoc ghostscript imagemagick python3 python3-pip
          python3 -m pip install --upgrade pip
          python3 -m pip install mkdocs mkdocs-material

      - name: Build Phase 2 Docs Site (strict errors)
        id: build
        continue-on-error: true
        run: |
          ./devtools/build-docs-phase2.sh \
            --out-dir build/docs-phase2-ci \
            --strict errors \
            --scope core-plus \
            --keep-going

      - name: Show Summary
        if: always()
        run: |
          if [ -f build/docs-phase2-ci/summary.md ]; then
            sed -n '1,220p' build/docs-phase2-ci/summary.md
          else
            echo "summary.md not found"
          fi

      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-phase2-site
          if-no-files-found: warn
          path: |
            build/docs-phase2-ci/site
            build/docs-phase2-ci/site-src
            build/docs-phase2-ci/summary.md
            build/docs-phase2-ci/summary.json
            build/docs-phase2-ci/manifest.content.json
            build/docs-phase2-ci/manifest.figures.json
            build/docs-phase2-ci/logs

      - name: Enforce Strict Errors Result
        if: steps.build.outcome != 'success'
        run: |
          echo "build-docs-phase2 failed under --strict errors"
          exit 1
